import{j as t,r as u}from"./tanstack-Bzt4YlFG.js";import{c as A,a as Mt,B as I,S as Tt,b as It,d as At,e as Lt,f as rt,T as sn,C as Rt,g as on,h as an,i as Ae,D as qe,j as He,k as Ye,l as Ve,m as Xe,I as Ee,n as ln,o as Je,X as cn}from"./index-CR0P747f.js";import{bv as _t,bX as dn,bY as un,bZ as mn,b_ as pn,b$ as $,c0 as W}from"./excalidraw-BwtJFo-T.js";import{S as st}from"./percentages-BXMCSKIN-DwPEa2la.js";import"./react-qkC6yhPU.js";import"./ui-DjwJxj-8.js";const fn=[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]],hn=A("arrow-up",fn);const gn=[["path",{d:"M12 18V5",key:"adv99a"}],["path",{d:"M15 13a4.17 4.17 0 0 1-3-4 4.17 4.17 0 0 1-3 4",key:"1e3is1"}],["path",{d:"M17.598 6.5A3 3 0 1 0 12 5a3 3 0 1 0-5.598 1.5",key:"1gqd8o"}],["path",{d:"M17.997 5.125a4 4 0 0 1 2.526 5.77",key:"iwvgf7"}],["path",{d:"M18 18a4 4 0 0 0 2-7.464",key:"efp6ie"}],["path",{d:"M19.967 17.483A4 4 0 1 1 12 18a4 4 0 1 1-7.967-.517",key:"1gq6am"}],["path",{d:"M6 18a4 4 0 0 1-2-7.464",key:"k1g0md"}],["path",{d:"M6.003 5.125a4 4 0 0 0-2.526 5.77",key:"q97ue3"}]],yn=A("brain",gn);const xn=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],wn=A("copy",xn);const bn=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],Qe=A("download",bn);const vn=[["path",{d:"M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4",key:"tonef"}],["path",{d:"M9 18c-4.51 2-5-2-7-2",key:"9comsn"}]],Sn=A("github",vn);const Cn=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],xt=A("info",Cn);const jn=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],Me=A("loader-circle",jn);const En=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M16.95 16.95A7 7 0 0 1 5 12v-2",key:"cqa7eg"}],["path",{d:"M18.89 13.23A7 7 0 0 0 19 12v-2",key:"16hl24"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}]],Nn=A("mic-off",En);const kn=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],Mn=A("mic",kn);const Tn=[["path",{d:"M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401",key:"kfwtm"}]],In=A("moon",Tn);const An=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],Ln=A("play",An);const Rn=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],_n=A("rotate-ccw",Rn);const Dn=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],On=A("search",Dn);const Pn=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],Gn=A("sun",Pn);const $n=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Bn=A("trash-2",$n);const Un=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],zn=A("triangle-alert",Un);const Wn=[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],Fn=A("wifi-off",Wn);const Kn=[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]],qn=A("wifi",Kn);function Hn({size:e=24,className:n,...r}){return t.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:e,height:e,viewBox:"0 0 512 512",fill:"currentColor",className:n,...r,children:t.jsx("path",{d:"M445.1 22.93c-3.8.11-7.9 1.81-11.5 5.98C379.2 107.6 318.8 184.7 257.3 261.4c2.3.9 4.5 1.9 6.5 3.1c4.5 2.5 8.4 5.6 11.7 9C339 197.6 401.3 121.1 455.6 40.87c4.3-9.84 1.1-13.83-3.8-16.4c-1.2-.65-2.6-1.13-4.1-1.37c-.8-.13-1.7-.19-2.6-.17M63.14 46.41c7.69 13.5 16.6 26.49 2.25 47.15c10.45-10.72 22.95-21.51 42.41-1.4c-4.2-10.17-17.26-17.99-6.1-33.71c-17.06 8.58-25.86 0-38.56-12.04M267.2 94.02c-7.4 11.08-18.3 14.68-32.6 10.28c14.3 4.9 21.5 14.5 17.7 31.7c8.3-15.5 18.1-21.4 29.5-17.1c-6.4-6.3-17.3-7-14.6-24.88m181.5 46.78c-4 22.5-6 45.9-43.2 50.9c22.9.8 48.1 3.7 51.7 46.2c5-15-3-37.8 25.6-41.3c-28.6-10.4-30.7-29.2-34.1-55.8m-358.92 96c2.1 24.8-8.1 41.4-37.08 45.6c29.38 3.7 44.88 15.4 45.88 35.5c5.62-13.5-.7-30.8 28.72-36.8c-22.1-5.2-34.82-19.7-37.52-44.3m155.42 39.7l-13.4 16.6c1.5.8 3 1.7 4.5 2.6c4.4 2.8 8.7 6.1 12.3 9.8l15.2-18c-2.3-2.7-5.4-5.4-8.9-7.4c-3-1.7-6.3-3-9.7-3.6M208 304.1c-.8 0-1.5 0-2 .1c-1 .2-1.5.5-1.7.7l-.5.6l-.6.4c-46.9 36-117.06 70.7-173.97 104.3c14.77 4.4 29.83 9.7 44.58 15.6l36.39-30.5L88.37 432c17.03 7.6 33.43 16.2 48.03 25.6l27.3-43.8l-12.2 54.2c9 6.7 17 13.8 23.8 21.1c27.2-59.1 63-100.2 67.7-154.8l.1-.6l.1-.6c.6-2.3-.2-5.7-3.1-10c-3-4.2-7.9-8.7-13.4-12.2c-5.4-3.4-11.5-5.8-15.9-6.5c-1.1-.2-2-.3-2.8-.3m111.2.2c9.7 13.1 9.9 25.8-4.7 38.3c17.6-8.2 30.3-7.2 37.8 3.6c-1.7-9.4-11.1-16.8 3-30.4c-14 4.8-26.1 1.2-36.1-11.5m56.7 90.8c11.7 17.4 20 29.5 4.1 47.8c23.4-10 29.5 7 41.2 13.8c-19.9-26.8-2.6-39.3 14.1-49.5c-30.5 12.8-44.4-.3-59.4-12.1"})})}function Yn({className:e,...n}){return t.jsx("div",{className:Mt("w-full max-w-[550px] mx-auto flex",e),...n})}const Dt="prompt-collapsed",Ze=192;function Vn(){if(typeof window>"u")return!1;try{return localStorage.getItem(Dt)==="true"}catch{return!1}}function Xn(e){const{mode:n,transcript:r,onModeChange:s,onGenerate:a,isGenerateDisabled:i=!1}=e,[l,o]=u.useState(Vn),m=u.useRef(null),d=u.useCallback(()=>{o(p=>{const v=!p;try{localStorage.setItem(Dt,String(v))}catch{}return v})},[]),f=u.useCallback(()=>{s?.(n==="auto"?"normal":"auto")},[n,s]),b=u.useCallback(p=>{p.key==="Enter"&&!p.shiftKey&&!i&&(p.preventDefault(),a?.())},[a,i]),g=u.useCallback(()=>{const p=m.current;p&&(p.style.height="auto",p.style.height=Math.min(p.scrollHeight,Ze)+"px",p.value&&(p.scrollTop=p.scrollHeight))},[]);return u.useEffect(()=>{const p=m.current;if(!p||l)return;p.style.height="auto";const v=Math.min(p.scrollHeight,Ze);p.style.height=v+"px",p.style.overflowY=v>=Ze?"auto":"hidden"},[l,r]),u.useEffect(()=>{l||g()},[l,g]),{isCollapsed:l,toggleCollapsed:d,toggleMode:f,handleKeyDown:b,scrollToTextareaEnd:g,textareaRef:m}}const Jn=new Set(["not-allowed","service-not-allowed"]),Qn={"not-allowed":"Microphone permission denied","service-not-allowed":"Speech recognition service not allowed","no-speech":"No speech detected",network:"Network error","audio-capture":"No microphone found"};function Zn(){return typeof window<"u"?window.SpeechRecognition??window.webkitSpeechRecognition:void 0}function er(e={}){const{lang:n="en-US",continuous:r=!0,interimResults:s=!0,onTranscript:a,onError:i}=e,l=Zn(),o=!!l,[m,d]=u.useState(!1),[f,b]=u.useState(""),g=u.useRef(null),p=u.useRef("idle"),v=u.useRef(!1),y=u.useRef(""),j=u.useRef(-1),T=u.useRef(a);T.current=a;const C=u.useRef(i);C.current=i;const N=u.useRef(r);N.current=r;const k=u.useCallback(()=>{if(g.current)return g.current;if(!l)return null;const S=new l;return S.lang=n,S.continuous=r,S.interimResults=s,S.onstart=()=>{p.current="listening",d(!0)},S.onresult=L=>{const U=[];for(let Y=j.current+1;Y<L.results.length;Y++){const F=L.results[Y],_=F[0].transcript.trim();_&&(F.isFinal?(y.current=y.current?`${y.current} ${_}`:_,j.current=Y):U.push(_))}const q=U.join(" "),ce=[y.current,q].filter(Boolean).join(" "),H=q.length===0&&y.current.length>0;b(ce),T.current?.(ce,H)},S.onerror=L=>{if(L.error==="aborted")return;Jn.has(L.error)&&(v.current=!1);const U=Qn[L.error]??`Speech error: ${L.error}`;C.current?.(U)},S.onend=()=>{if(p.current="idle",d(!1),N.current&&v.current){j.current=-1;try{p.current="starting",S.start()}catch{p.current="idle"}}},g.current=S,S},[l,n,r,s]);u.useEffect(()=>{const S=g.current;S&&(S.lang=n,S.continuous=r,S.interimResults=s)},[n,r,s]);const E=u.useCallback(()=>{if(p.current!=="idle")return;const S=k();if(S){y.current="",j.current=-1,b(""),v.current=!0,p.current="starting";try{S.start()}catch(L){p.current="idle",C.current?.(L instanceof Error?L.message:"Failed to start speech recognition")}}},[k]),w=u.useCallback(()=>{if(!(p.current!=="starting"&&p.current!=="listening")){v.current=!1,y.current="",j.current=-1,p.current="stopping";try{g.current?.stop()}catch{p.current="idle",d(!1),C.current?.("Failed to stop speech recognition")}}},[]),M=u.useCallback(()=>{p.current==="idle"?E():(p.current==="starting"||p.current==="listening")&&w()},[E,w]);return u.useEffect(()=>()=>{g.current?.abort()},[]),{isSupported:o,isListening:m,transcript:f,start:E,stop:w,toggle:M}}function tr({lang:e,onTranscript:n,onRecognitionError:r,onMicStateChange:s,autoMode:a,onClick:i,className:l,...o}){const{isSupported:m,isListening:d,toggle:f}=er({lang:e,onTranscript:n,onError:r}),b=a&&!d,g=a&&d;return u.useEffect(()=>{s?.(d)},[d,s]),m?t.jsx(I,{type:"button",size:"icon",variant:"secondary","aria-label":d?"Stop voice input":"Start voice input",className:Mt("group transition-all duration-200 shadow-none","bg-[var(--sidebar-trigger-bg,var(--toolbar-button-bg,var(--secondary)))] text-[var(--sidebar-trigger-color,var(--toolbar-button-color,var(--foreground)))]","hover:brightness-110",b&&"animate-[pulse_2s_ease-in-out_infinite]",g&&"animate-[pulse_1s_ease-in-out_infinite]",l),onClick:p=>{f(),i?.(p)},...o,children:d?t.jsx(Nn,{className:"text-destructive transition-all duration-200"}):t.jsx(Mn,{className:"transition-all duration-200"})}):null}function nr({webLLMModels:e,localModels:n,currentModel:r,onSelectModel:s,localServerConfigured:a=!1}){const[i,l]=u.useState(!1),o=e.length>0||n.length>0,m=a||n.length>0;if(!o&&!a)return null;const d=r.length>18?r.slice(0,18)+"...":r;return t.jsxs(Tt,{open:i,onOpenChange:l,value:r,onValueChange:f=>{s(f),l(!1)},children:[t.jsxs(It,{className:"h-9 w-auto min-w-[100px] gap-1 px-2","aria-label":"Select model",children:[t.jsx(yn,{className:"h-3.5 w-3.5"}),t.jsx(At,{placeholder:"Model",children:t.jsx("span",{className:"truncate max-w-[80px]",children:d})})]}),t.jsxs(Lt,{align:"start",className:"max-h-[300px]",children:[e.length>0&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"px-2 py-1.5 text-xs font-semibold text-muted-foreground",children:"WebLLM"}),e.map(f=>t.jsx(rt,{value:f.id,className:"text-xs",children:t.jsx("span",{className:"truncate block max-w-[180px]",children:f.id})},f.id))]}),m&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"px-2 py-1.5 text-xs font-semibold text-muted-foreground flex items-center gap-1",children:[t.jsx(qn,{className:"h-3 w-3"}),"Local Server"]}),n.length>0?n.map(f=>t.jsx(rt,{value:f.id,className:"text-xs",children:t.jsx("span",{className:"truncate block max-w-[180px]",children:f.name||f.id})},f.id)):t.jsxs("div",{className:"px-3 py-2 text-xs text-muted-foreground flex items-center gap-1",children:[t.jsx(Fn,{className:"h-3 w-3"}),"Not connected"]})]})]})]})}function rr({prompt:e,onPromptChange:n,mode:r,onModeChange:s,onGenerate:a,generateDisabled:i,generating:l=!1,onTranscript:o,onRecognitionError:m,loading:d=!1,loadProgress:f=0,inputAriaDescribedBy:b,inputAriaInvalid:g=!1,webLLMModels:p,localModels:v,currentModel:y,onSelectModel:j,localServerConfigured:T=!1}){const{isCollapsed:C,toggleCollapsed:N,handleKeyDown:k,textareaRef:E}=Xn({mode:r,transcript:e,onModeChange:s,onGenerate:a,isGenerateDisabled:i});return t.jsxs(Yn,{className:"flex-col gap-2 text-foreground",children:[(d||l)&&t.jsx("div",{className:"h-1.5 w-full max-w-[550px] mx-auto rounded-full bg-muted overflow-hidden",role:"progressbar","aria-valuenow":d?Math.round(f*100):void 0,"aria-valuemin":0,"aria-valuemax":100,"aria-label":d?"Downloading model":"Generating diagram",children:t.jsx("div",{className:`h-full bg-primary transition-all duration-150 ${l&&!d?"animate-pulse":""}`,style:{width:d?`${f*100}%`:"100%"}})}),t.jsx("div",{className:"rounded-lg bg-[var(--toolbar-bg,var(--card))] p-2 shadow-[0_2px_4px_rgba(0,0,0,0.04),0_-2px_4px_rgba(0,0,0,0.04),2px_0_4px_rgba(0,0,0,0.04),-2px_0_4px_rgba(0,0,0,0.04)] w-full max-w-[550px]",children:t.jsxs("div",{className:"flex w-full flex-col gap-2",children:[!C&&t.jsxs("div",{className:"relative",children:[t.jsx(sn,{ref:E,value:e,onChange:w=>n(w.target.value),onKeyDown:k,placeholder:"Describe a diagram or use the mic...",className:"min-h-[22px] max-h-[192px] min-w-0 w-full flex-1 resize-none border-0 bg-[var(--toolbar-bg,var(--card))] px-2.5 py-0.5 text-sm leading-tight shadow-none placeholder:text-muted-foreground overflow-x-hidden break-words whitespace-pre-wrap focus-visible:ring-0 focus-visible:ring-offset-0",wrap:"hard",style:{whiteSpace:"pre-wrap",wordBreak:"break-word"},"aria-label":"Diagram description","aria-invalid":g,"aria-describedby":b,rows:1}),t.jsx(I,{type:"button",variant:"ghost",size:"icon",className:"absolute top-0.5 right-0.5 h-5 w-5 opacity-60 hover:opacity-100 shadow-none",onClick:N,"aria-label":"Collapse textarea",children:t.jsx(Rt,{className:"h-2.5 w-2.5"})})]}),t.jsxs("div",{className:"flex w-full items-center justify-between gap-2",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[C&&t.jsx(I,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9 opacity-60 hover:opacity-100 shadow-none",onClick:N,"aria-label":"Expand textarea",children:t.jsx(on,{className:"h-4 w-4"})}),t.jsx(tr,{onTranscript:o,onRecognitionError:m,autoMode:r==="auto"}),t.jsxs("div",{className:"relative inline-flex h-6 w-[calc(3.5rem+1.25rem)] items-center rounded-full bg-input/50 px-0.5 overflow-hidden shadow-sm",children:[t.jsx(an,{checked:r==="auto",onCheckedChange:w=>s(w?"auto":"normal"),className:"peer absolute inset-0 h-full w-full rounded-full data-[state=checked]:bg-primary data-[state=unchecked]:bg-input/50 [&_span]:z-10 [&_span]:h-5 [&_span]:w-5 [&_span]:rounded-full [&_span]:bg-primary [&_span]:data-[state=checked]:bg-white [&_span]:border [&_span]:border-transparent [&_span]:shadow-sm [&_span]:transition-transform [&_span]:duration-300 [&_span]:ease-[cubic-bezier(0.16,1,0.3,1)] [&_span]:data-[state=unchecked]:translate-x-0.5 [&_span]:data-[state=checked]:translate-x-[3.25rem]","aria-label":"Toggle mode"}),t.jsxs("div",{className:"relative z-20 flex h-full w-full items-center pointer-events-none",children:[t.jsx("span",{className:`absolute left-0 right-[calc(1.25rem+0.25rem)] text-[9px] font-medium uppercase transition-all duration-300 ease-[cubic-bezier(0.16,1,0.3,1)] whitespace-nowrap flex items-center justify-center h-full ${r==="auto"?"text-primary-foreground opacity-100":"text-transparent opacity-0"}`,children:"Auto"}),t.jsx("span",{className:`absolute right-[0.125rem] left-[calc(1.25rem+0.125rem+0.125rem)] text-[9px] font-medium uppercase transition-all duration-300 ease-[cubic-bezier(0.16,1,0.3,1)] whitespace-nowrap flex items-center justify-center h-full ${r==="normal"?"text-foreground opacity-100":"text-transparent opacity-0"}`,children:"Normal"})]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[p?.length||v?.length||T?t.jsx(nr,{webLLMModels:p||[],localModels:v||[],currentModel:y||"Select model",onSelectModel:j||(()=>{}),localServerConfigured:T}):null,t.jsx(I,{type:"button",onClick:a,disabled:i,variant:"default",size:"icon","aria-label":l?"Generating...":"Generate diagram",title:r==="auto"?"Submit disabled in auto mode":void 0,children:t.jsx(hn,{className:"h-4 w-4"})})]})]})]})})]})}let Ne=null,ke=null;async function sr(){if(Ne)return Ne;if(ke)throw ke;try{const{prebuiltAppConfig:e}=await _t(async()=>{const{prebuiltAppConfig:n}=await import("./webllm-DjDXyXy_.js");return{prebuiltAppConfig:n}},[]);return Ne=e.model_list,Ne}catch(e){throw ke=e instanceof Error?e:new Error(String(e)),ke}}async function Ot(){return(await sr()).map(n=>({id:n.model_id,name:n.model_id,vramMB:Math.round(n.vram_required_MB??0),lowResource:n.low_resource_required??!1,contextWindow:4096}))}const ne=[{type:"opencode",name:"OpenCode Serve",defaultUrl:"http://127.0.0.1:4096",description:"OpenCode's built-in local server"},{type:"ollama",name:"Ollama",defaultUrl:"http://localhost:11434/v1",description:"Popular local LLM runner",comingSoon:!0},{type:"vllm",name:"vLLM",defaultUrl:"http://localhost:8000/v1",description:"High-throughput inference engine",comingSoon:!0},{type:"lmstudio",name:"LM Studio",defaultUrl:"http://localhost:1234/v1",description:"User-friendly local LLM UI",comingSoon:!0},{type:"llamacpp",name:"llama.cpp / llamafile",defaultUrl:"http://localhost:8080/v1",description:"Lightweight C++ inference",comingSoon:!0},{type:"custom",name:"Custom",defaultUrl:"http://localhost:8000/v1",description:"Custom OpenAI-compatible endpoint",comingSoon:!0}],or="Qwen2.5-Coder-1.5B-Instruct-q4f16_1-MLC",le={type:"webllm",modelId:or},Le="AES-GCM",wt=256,ar=12;function bt(e){const n=new Uint8Array(e);let r="";for(let s=0;s<n.byteLength;s++)r+=String.fromCharCode(n[s]);return btoa(r)}function vt(e){const n=atob(e),r=new Uint8Array(n.length);for(let s=0;s<n.length;s++)r[s]=n.charCodeAt(s);return r}async function Pt(){const e=localStorage.getItem("drawmaid-encryption-key");if(e){const s=JSON.parse(e);return crypto.subtle.importKey("jwk",s,{name:Le,length:wt},!0,["encrypt","decrypt"])}const n=await crypto.subtle.generateKey({name:Le,length:wt},!0,["encrypt","decrypt"]),r=await crypto.subtle.exportKey("jwk",n);return localStorage.setItem("drawmaid-encryption-key",JSON.stringify(r)),n}async function St(e){const n=await Pt(),r=crypto.getRandomValues(new Uint8Array(ar)),a=new TextEncoder().encode(e),i=await crypto.subtle.encrypt({name:Le,iv:r},n,a);return{ciphertext:bt(i),iv:bt(r.buffer)}}async function ir(e,n){const r=await Pt(),s=vt(e).buffer,a=vt(n).buffer,i=await crypto.subtle.decrypt({name:Le,iv:new Uint8Array(a)},r,s);return new TextDecoder().decode(i)}const be="drawmaid-ai-config",Ge="drawmaid-downloaded-models";let oe=null,Te=!1,ie=null;function lr(){Te=!1,oe=null}function cr(){ie=null}async function dr(){if(Te&&oe)return oe;try{return oe=await Ut(),Te=!0,oe}catch{return oe=le,Te=!0,oe}}const me=new Set,Re=new Set;let ge=null,ot=!1;function ur(){ot||typeof window>"u"||(ge=async e=>{if(e.key===be){const n=await Ut();me.forEach(r=>r(n)),lr()}else if(e.key===Ge){const n=X();Re.forEach(r=>r(n)),cr()}},window.addEventListener("storage",ge),ot=!0)}function mr(){ge&&(window.removeEventListener("storage",ge),ge=null,ot=!1)}typeof window<"u"&&ur();function Gt(e){return me.add(e),()=>{me.delete(e),me.size===0&&mr()}}function pr(e){return Re.add(e),()=>{Re.delete(e)}}function $t(e){Re.forEach(n=>n(e))}async function fr(e){let n;if(e.type==="local"){const r=e;if(r.apiKey){const{ciphertext:s,iv:a}=await St(r.apiKey),{apiKey:i,...l}=r;n={config:{type:"local",serverType:l.serverType,url:l.url,model:l.model},encryptedApiKey:s,iv:a}}else n={config:e}}else if(e.type==="byok"){const r=e,{ciphertext:s,iv:a}=await St(r.apiKey),{apiKey:i,...l}=r;n={config:{type:"byok",provider:l.provider,model:l.model},encryptedApiKey:s,iv:a}}else n={config:e};return JSON.stringify(n)}async function hr(e){const n=JSON.parse(e),r=n.config;if(n.encryptedApiKey&&n.iv){const s=await ir(n.encryptedApiKey,n.iv);r.type==="local"?(r.apiKey=s,r.serverType||(r.serverType="opencode")):r.type==="byok"&&(r.apiKey=s)}return r}async function gr(e){const n=await fr(e);localStorage.setItem(be,n),me.forEach(r=>r(e))}function Bt(){const e=localStorage.getItem(be);if(!e)return le;try{const n=JSON.parse(e);return n&&typeof n=="object"&&"config"in n?n.config:n}catch{return le}}async function Ut(){const e=localStorage.getItem(be);if(!e)return le;try{return await hr(e)}catch{return le}}function yr(){localStorage.removeItem(be),me.forEach(e=>e(le))}function X(){if(ie)return ie;const e=localStorage.getItem(Ge);if(!e)return[];try{return ie=JSON.parse(e),ie}catch{return[]}}function xr(e){const n=X();n.includes(e)||(n.push(e),ie=n,localStorage.setItem(Ge,JSON.stringify(n)),$t(n))}function wr(e){const r=X().filter(s=>s!==e);ie=r,localStorage.setItem(Ge,JSON.stringify(r)),$t(r)}async function zt(e,n,r){try{const s=new AbortController,a=setTimeout(()=>s.abort(),1e4),i=vr(e,r),l=await fetch(i,{method:"GET",headers:n?{Authorization:`Bearer ${n}`}:{},signal:s.signal});if(clearTimeout(a),!l.ok)return{success:!1,error:`Server returned ${l.status}: ${l.statusText}`};const o=await l.json(),m=[];if(o.data&&Array.isArray(o.data))for(const d of o.data)d.id&&m.push({id:d.id,name:d.id});else if(o.providers&&Array.isArray(o.providers))at(o.providers,o.default,m);else if(o.providers&&typeof o.providers=="object")at(Object.values(o.providers),o.default,m);else if(Array.isArray(o))for(const d of o)typeof d=="string"?m.push({id:d,name:d}):d.id&&m.push({id:d.id,name:d.id});if(r==="opencode"&&m.length===0){const d=await br(e,n);if(d.length>0)return{success:!0,models:d}}return{success:!0,models:m}}catch(s){return s instanceof Error&&s.name==="AbortError"?{success:!1,error:"Connection timed out"}:{success:!1,error:s instanceof Error?s.message:"Failed to fetch models"}}}function at(e,n,r){for(const a of e){if(!a||typeof a!="object")continue;const i=a,l=typeof i.id=="string"?i.id:typeof i.name=="string"?i.name:void 0;if(i.models){if(Array.isArray(i.models)){for(const o of i.models)if(typeof o=="string")r.push({id:l?`${l}:${o}`:o,name:l?`${l}:${o}`:o,providerId:l,modelId:o});else if(o&&typeof o=="object"&&"id"in o){const m=o.id;r.push({id:l?`${l}:${m}`:m,name:l?`${l}:${m}`:m,providerId:l,modelId:m})}}else if(typeof i.models=="object"){const o=Object.entries(i.models);for(const[m,d]of o)if(typeof m=="string"&&r.push({id:l?`${l}:${m}`:m,name:l?`${l}:${m}`:m,providerId:l,modelId:m}),d&&typeof d=="object"&&"id"in d){const f=d.id;r.push({id:l?`${l}:${f}`:f,name:l?`${l}:${f}`:f,providerId:l,modelId:f})}}}i.model&&typeof i.model=="string"&&r.push({id:l?`${l}:${i.model}`:i.model,name:l?`${l}:${i.model}`:i.model,providerId:l,modelId:i.model}),i.defaultModel&&typeof i.defaultModel=="string"&&r.push({id:l?`${l}:${i.defaultModel}`:i.defaultModel,name:l?`${l}:${i.defaultModel}`:i.defaultModel,providerId:l,modelId:i.defaultModel})}if(n&&typeof n=="object")for(const a of Object.values(n))typeof a=="string"&&r.push({id:a,name:a});const s=new Map;for(const a of r)s.has(a.id)||s.set(a.id,a);r.length=0,r.push(...s.values())}async function br(e,n){try{const r=await fetch(`${e}/provider`,{method:"GET",headers:n?{Authorization:`Bearer ${n}`}:{}});if(!r.ok)return[];const s=await r.json(),a=[];return s?.all&&Array.isArray(s.all)&&at(s.all,s.default,a),a}catch{return[]}}function vr(e,n){return e.endsWith("/v1")?`${e}/models`:e.endsWith("/v1/")?`${e}models`:n==="opencode"?`${e}/config/providers`:e.includes("127.0.0.1:4096")||e.includes("localhost:4096")?`${e}/config/providers`:`${e}/v1/models`}async function Sr(){if(typeof navigator>"u")return{supported:!1,message:"WebGPU is not available in this environment.",canTest:!1};if(!("gpu"in navigator))return{supported:!1,message:"WebGPU is not supported in your browser. Try Chrome or Edge.",canTest:!1};try{const e=await navigator.gpu.requestAdapter();if(!e)return{supported:!1,message:"No GPU adapter found. Enable WebGPU in chrome://flags or use a GPU-enabled browser.",canTest:!1};const n=e.info;return{supported:!0,message:`WebGPU available (${n.description||n.vendor||n.architecture||"GPU"})`,canTest:!0}}catch(e){const n=e instanceof Error?e.message:String(e);return console.warn("WebGPU check failed:",n),{supported:!1,message:`WebGPU error: ${n}. Try enabling chrome://flags/#enable-webgpu-developer-features`,canTest:!1}}}function Wt({onConfigureClick:e}){const[n,r]=u.useState(null),[s,a]=u.useState(!0);return u.useEffect(()=>{Sr().then(i=>{r(i),a(!1)})},[]),s?t.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[t.jsx(Me,{className:"h-4 w-4 animate-spin"}),t.jsx("span",{children:"Checking WebGPU..."})]}):n?t.jsxs("div",{className:`flex items-center gap-3 rounded-lg border p-3 text-sm cursor-pointer hover:opacity-80 transition-opacity ${n.supported?"border-green-500/30 bg-green-500/10 text-green-600 dark:text-green-400":"border-amber-500/30 bg-amber-500/10 text-amber-600 dark:text-amber-400"}`,onClick:e,role:"button",tabIndex:0,onKeyDown:i=>i.key==="Enter"&&e(),children:[n.supported?t.jsx(Ae,{className:"h-4 w-4 shrink-0"}):t.jsx(zn,{className:"h-4 w-4 shrink-0"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium",children:n.supported?"WebGPU Available":"WebGPU Not Available"}),t.jsx("p",{className:"text-xs opacity-80 truncate",children:n.supported?"Configure AI to use WebLLM or Local Server":"Enable hardware acceleration in your browser to use WebLLM"})]})]}):null}const J=`ROLE:
You are a mermaid diagram code completing expert. You understand the user's thought process and help them visualize by creating mermaid diagrams.

RULES:

- Output ONLY valid mermaid code
- No explanations, no markdown fences (no \`\`\`)
- Never use reserved keywords as node/participant/class names
- Use _ suffix if reserved word is needed (e.g., end_)
- Always include proper diagram declaration line

BEHAVIOR:

- Read user intent carefully from their thought process
- Choose appropriate diagram type based on context
- Use provided syntax rules and examples as reference
- Create clear, logical flow based on user's description
- Correct any spelling mistakes in the input
- If unclear, create nodes from key terms only - don't hallucinate connections
`,Cr=1e4;function jr(e){return new DOMException(`Generation timed out after ${e}ms`,"TimeoutError")}const Er="Qwen2.5-Coder-1.5B-Instruct-q4f16_1-MLC";let Q={status:"idle",loadProgress:0,error:null,output:""};const it=new Set;function B(e){Q={...Q,...e},it.forEach(n=>n())}function lt(e){return it.add(e),()=>{it.delete(e)}}function Ie(){return Q}let G=null,ue=null,_e=null,ye=null,xe=null,ae=0,he=0;function pe(){return new DOMException("Aborted","AbortError")}function Nr(){return typeof navigator<"u"&&"gpu"in navigator}function De(e){const n=e||Er;if(G)return Q.status==="error"&&B({status:"ready",error:null}),Promise.resolve();if(Q.status==="loading"&&ue)return ue;const r=he;B({status:"loading",loadProgress:0,error:null});const s=new Promise((a,i)=>{xe=i});return ue=(async()=>{let a=null,i=null;try{const{CreateWebWorkerMLCEngine:l}=await Promise.race([_t(()=>import("./webllm-DjDXyXy_.js"),[]),s]);a=new Worker(new URL("/drawmaid/assets/mermaid-llm.worker-BiHSaKQl.js",import.meta.url),{type:"module"}),ye=a,i=l(a,n,{initProgressCallback:m=>{r===he&&B({loadProgress:m.progress})}});const o=await Promise.race([i,s]);if(xe=null,r!==he)throw o.unload().catch(()=>{}),pe();G=o,_e=a,ye=null,B({status:"ready",loadProgress:1})}catch(l){throw xe=null,a&&a!==_e&&a.terminate(),ye=null,i?.then(o=>o.unload().catch(()=>{}),()=>{}),Oe(l)?l:r!==he?pe():(B({status:"error",error:l instanceof Error?l.message:String(l)}),ue=null,l)}})(),ue}async function Ft(e,n){const r=n?.disableAbort??!1;if(Q.status==="error"&&G){try{await Kt()}catch{}G=null}if(r&&(Q.status==="generating"||Q.status==="loading")){try{G?.interruptGenerate()}catch{}B({status:"ready"})}if(!r)try{G?.interruptGenerate()}catch{}const s=++ae;if(B({output:"",error:null}),!G&&(await De(n?.modelId),!G))throw new Error("Engine failed to load");try{G.resetChat()}catch{}if(!r&&s!==ae)throw pe();B({status:"generating"});const a=n?.timeoutMs??Cr;let i;const l=new Promise((o,m)=>{i=setTimeout(()=>m(jr(a)),a)});try{const o=await Promise.race([G.chat.completions.create({messages:[{role:"system",content:n?.systemPrompt??J},{role:"user",content:e}],stream:!0,max_tokens:n?.maxTokens??1024,temperature:n?.temperature??.1}),l]),m=[];let d="";for await(const b of o){if(!r&&s!==ae)break;const g=b.choices[0]?.delta?.content??"";g&&(m.push(g),d+=g,B({output:d}))}const f=m.join("");if(!r&&s!==ae)throw pe();return B({status:"ready"}),f}catch(o){if(Oe(o))throw o;if(!r&&s!==ae)throw pe();if(qt(o))try{G?.interruptGenerate()}catch{}throw B({status:"error",error:o instanceof Error?o.message:String(o)}),o}finally{clearTimeout(i)}}function kr(){if(ae++,Q.status==="generating"){try{G?.interruptGenerate()}catch{}B({status:"ready"})}}async function Kt(){ae++,he++,xe?.(pe()),xe=null,ye?.terminate(),ye=null;try{await G?.unload()}catch{}_e?.terminate(),G=null,ue=null,_e=null,B({status:"idle",loadProgress:0,output:"",error:null})}function Oe(e){return e instanceof Error&&e.name==="AbortError"}function qt(e){return e instanceof Error&&e.name==="TimeoutError"}async function*Ht(e,n,r={}){const{url:s,apiKey:a,model:i}=e,{maxTokens:l=1024,temperature:o=.1,signal:m}=r,d=await fetch(Mr(s,e.serverType),{method:"POST",headers:{"Content-Type":"application/json",...a?{Authorization:`Bearer ${a}`}:{}},body:JSON.stringify({model:i,messages:n,max_tokens:l,temperature:o,stream:!0}),signal:m});if(!d.ok){const v=await d.text();throw new Error(`Local server error: ${d.status} - ${v}`)}const f=d.headers.get("content-type")??"";if(!d.body||f.includes("application/json")){const v=await d.json(),y=v?.choices?.[0]?.message?.content??v?.choices?.[0]?.text??v?.response??"";y&&(yield y);return}const b=d.body.getReader(),g=new TextDecoder;let p="";try{for(;;){const{done:v,value:y}=await b.read();if(v)break;p+=g.decode(y,{stream:!0});const j=p.split(`
`);p=j.pop()||"";for(const T of j){const C=T.trim();if(!C||!C.startsWith("data:"))continue;const N=C.slice(5).trim();if(N==="[DONE]")return;try{const k=JSON.parse(N),E=k.choices?.[0]?.delta?.content??k.choices?.[0]?.text??k?.response;E&&(yield E)}catch{}}}}finally{b.releaseLock()}}function Mr(e,n){return e.endsWith("/v1")?`${e}/chat/completions`:e.endsWith("/v1/")?`${e}chat/completions`:n==="opencode"?`${e}/v1/chat/completions`:`${e}/chat/completions`}async function Tr(e,n,r,s={}){const a=[{role:"system",content:n},{role:"user",content:r}],i=[],l=s.timeoutMs??3e4,o=new AbortController,m=setTimeout(()=>o.abort(),l),d=s.signal?s.signal:o.signal;try{for await(const f of Ht(e,a,{maxTokens:s.maxTokens,temperature:s.temperature,signal:d}))i.push(f);return i.join("")}finally{clearTimeout(m)}}const Ir=80;function gt(e,n){return`drawmaid-opencode-${n}:${e}`}function ct(e){return gt(e,"session")}function Pe(e){return gt(e,"summary")}function dt(e){return gt(e,"usage")}function we(e){localStorage.removeItem(ct(e)),localStorage.removeItem(Pe(e)),localStorage.removeItem(dt(e))}async function Ct(e,n){const r=localStorage.getItem(ct(e));if(r)return r;const s=await fetch(`${e}/session`,{method:"POST",headers:{"Content-Type":"application/json",...n?{Authorization:`Basic ${btoa(`opencode:${n}`)}`}:{}},body:JSON.stringify({})});if(!s.ok){const i=await s.text();throw new Error(`OpenCode session error: ${s.status} - ${i}`)}const a=await s.json();if(!a.id)throw new Error("OpenCode session response missing id");return localStorage.setItem(ct(e),a.id),a.id}function ut(e){return!e||!Array.isArray(e)?"":e.map(n=>n.text||n.content||"").filter(Boolean).join("")}function Ar(e){if(!e)return null;const n=e.usage;if(n){const r=n.context_percent;if(typeof r=="number")return r;const s=n.context;if(s){const l=s.percentage;if(typeof l=="number")return l;const o=s.used,m=s.total;if(typeof o=="number"&&typeof m=="number"&&m>0)return o/m*100}const a=n.tokens_used,i=n.tokens_max;if(typeof a=="number"&&typeof i=="number"&&i>0)return a/i*100}return null}async function mt(e,n,r,s,a,i,l=3e4){const[o,m]=r.includes(":")?r.split(":",2):["opencode",r],d=new AbortController,f=setTimeout(()=>d.abort(),l);try{const b=await fetch(`${e}/session/${n}/message`,{method:"POST",signal:d.signal,headers:{"Content-Type":"application/json",...i?{Authorization:`Basic ${btoa(`opencode:${i}`)}`}:{}},body:JSON.stringify({model:{providerID:o,modelID:m},system:s,parts:[{type:"text",text:a}]})});if(clearTimeout(f),!b.ok){const g=await b.text();throw new Error(`OpenCode message error: ${b.status} - ${g}`)}return await b.json()}catch(b){throw clearTimeout(f),b instanceof Error&&b.name==="AbortError"?new Error(`OpenCode request timed out after ${l}ms`):b}}async function Lr(e,n,r,s,a){const l=await mt(e,n,r,s,"Summarize the conversation so far into a concise context for future requests.",a),o=ut(l.parts);return o&&localStorage.setItem(Pe(e),o),o}async function Yt(e,n,r){const s=e.url.replace(/\/$/,"");try{const a=await Ct(s,e.apiKey),i=localStorage.getItem(Pe(s)),l=i?`Context summary:
${i}

${r}`:r,o=await mt(s,a,e.model,n,l,e.apiKey),m=Ar(o);return typeof m=="number"&&(localStorage.setItem(dt(s),String(m)),m>=Ir&&await Lr(s,a,e.model,n,e.apiKey)),we(s),ut(o.parts)}catch(a){const i=a instanceof Error?a.message:String(a);if(i.includes("timed out")||i.includes("session")||i.includes("aborted")){we(s),localStorage.removeItem(Pe(s)),localStorage.removeItem(dt(s));const o=await Ct(s,e.apiKey),m=await mt(s,o,e.model,n,r,e.apiKey,15e3);return we(s),ut(m.parts)}throw a}}const et="Introduce yourself and tell me what you can help me create. Keep it brief (2-3 sentences).";function Rr({open:e,onOpenChange:n,onModelDownloaded:r}){const[s,a]=u.useState("webllm"),[i,l]=u.useState("available"),[o,m]=u.useState(()=>Bt()),[d,f]=u.useState("idle"),[b,g]=u.useState(null),[p,v]=u.useState(!1),[y,j]=u.useState(0),[T,C]=u.useState([]),[N,k]=u.useState(null),[E,w]=u.useState(null),[M,S]=u.useState(null),[L,U]=u.useState(null),[q,ce]=u.useState(""),[H,Y]=u.useState([]);u.useEffect(()=>{Ot().then(Y).catch(c=>{console.error("Failed to load WebLLM models:",c),Y([])})},[]);const[F,_]=u.useState([]),[$e,z]=u.useState("idle"),[re,Be]=u.useState(!1);u.useEffect(()=>Gt(x=>{m(x)}),[]),u.useEffect(()=>(j(Ie().loadProgress),lt(()=>{j(Ie().loadProgress)})),[]);const ve=u.useCallback(c=>{console.log("Opening download confirm for:",c),S(c)},[]),Se=u.useCallback(()=>{console.log("Cancelling download"),S(null)},[]),Ue=u.useCallback(async c=>{console.log("Confirming download for:",c),S(null),k(c);try{await De(c),xr(c);const x=[...X()];C(x),r?.()}catch(x){g(x instanceof Error?x.message:"Download failed"),f("error")}finally{k(null)}},[]),h=u.useCallback(c=>{console.log("Opening delete confirm for:",c),U(c)},[]),R=u.useCallback(()=>{console.log("Cancelling delete"),U(null)},[]),Z=u.useCallback(c=>{console.log("Confirming delete for:",c),U(null),wr(c);const x=[...X()];C(x)},[]),D=u.useCallback(async(c,x,O)=>{z("connecting");try{const P=await zt(c,x,O);P.success&&P.models?(_(P.models),z("connected"),P.models.length>0&&!o.model&&m({...o,model:P.models[0].id})):(_([]),z("error"))}catch{_([]),z("error")}},[o]);u.useEffect(()=>{if(!e||s!=="local")return;if(o.type!=="local"){const je={type:"local",serverType:"opencode",url:ne.find(rn=>rn.type==="opencode")?.defaultUrl||"http://127.0.0.1:4096",model:""};m(je),D(je.url,je.apiKey,je.serverType);return}const c=o,x=c.serverType||"opencode",O=ne.find(te=>te.type===x),P=c.url||O?.defaultUrl||"http://127.0.0.1:4096";(P!==c.url||c.serverType!==x)&&m({...c,serverType:x,url:P}),D(P,c.apiKey,x)},[s,o,e,D]);const V=c=>{switch(c){case"opencode":return"Run 'opencode serve' in terminal to start the local server, then connect here. Default: http://127.0.0.1:4096";case"ollama":return"Run `ollama serve` or start Ollama app. Default: http://localhost:11434/v1.";case"vllm":return"Run `vllm serve <model>` then use http://localhost:8000/v1.";case"lmstudio":return"Start server in LM Studio â†’ Developer tab. Default: http://localhost:1234/v1.";case"llamacpp":return"Start server with `--port 8080` and use http://localhost:8080/v1.";default:return"Enter your OpenAI-compatible base URL."}},fe=async c=>{f("testing"),g(null),w("");try{await De(c);const x=lt(()=>{const O=Ie();w(O.output)});await Ft(et,{systemPrompt:J}),f("success"),x()}catch(x){g(x instanceof Error?x.message:"Test failed"),f("error")}},se=()=>{if(o.type==="local"){const c=o;if(!c.url)return"Server URL is required";if(!c.url.startsWith("http://")&&!c.url.startsWith("https://"))return"URL must start with http:// or https://";if(!c.model)return"Model name is required"}return null},K=async()=>{const c=se();if(c){g(c),f("error");return}f("testing"),g(null),w("");try{if(o.type==="local"){const x=o;if(x.serverType==="opencode"){const te=await Yt(x,J,et);w(te),f("success");return}const O=[{role:"system",content:J},{role:"user",content:et}];let P="";for await(const te of Ht(x,O,{maxTokens:256,temperature:.2}))P+=te,w(P);f("success")}}catch(x){g(x instanceof Error?x.message:"Test failed"),f("error")}},ze=async()=>{const c=se();if(c){g(c),f("error");return}if(Ke){const x=ne.find(O=>O.type==="opencode");m({...o,type:"local",serverType:"opencode",url:x?.defaultUrl||"http://127.0.0.1:4096",model:""}),g("Coming soon! Switched to OpenCode Serve."),f("error");return}v(!0);try{await gr(o),n(!1)}catch(x){g(x instanceof Error?x.message:"Failed to save"),f("error")}finally{v(!1)}},We=()=>{yr(),m(le),a("webllm"),f("idle"),g(null)},ee=!1,Ce=!0,yt=H.filter(c=>!T.includes(c.id)).filter(c=>c.name.toLowerCase().includes(q.toLowerCase())),Fe=H.filter(c=>T.includes(c.id)).filter(c=>c.name.toLowerCase().includes(q.toLowerCase())),tn=N!==null,nn=o.serverType||"opencode",Ke=ne.find(c=>c.type===nn)?.comingSoon??!1;return t.jsxs(t.Fragment,{children:[t.jsx(qe,{open:e,onOpenChange:n,children:t.jsxs(He,{className:"sm:max-w-[600px] max-h-[85vh] overflow-hidden flex flex-col p-0",children:[t.jsxs(Ye,{className:"px-6 pt-6",children:[t.jsxs(Ve,{className:"flex items-center gap-2",children:[t.jsx(st,{className:"h-5 w-5"}),"AI Configuration"]}),t.jsx(Xe,{children:"Choose how Drawmaid generates diagrams. WebLLM runs in your browser, or connect to a local or cloud AI server."})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto px-6 py-4 space-y-4",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsx(I,{variant:s==="webllm"?"default":"outline",size:"sm",onClick:()=>a("webllm"),disabled:ee,className:"flex-1",children:"WebLLM"}),t.jsx(I,{variant:s==="local"?"default":"outline",size:"sm",onClick:()=>a("local"),className:"flex-1",children:"Local Server"}),t.jsxs(I,{variant:s==="byok"?"default":"outline",size:"sm",onClick:()=>a("byok"),disabled:Ce,className:"flex-1",children:["BYOK"," ðŸ”’"]})]}),s==="webllm"&&t.jsxs("div",{className:"space-y-4",children:[t.jsx("div",{className:"rounded-lg border bg-muted/50 p-3",children:t.jsx(Wt,{onConfigureClick:()=>{}})}),!T.includes("Qwen2.5-Coder-1.5B-Instruct-q4f16_1-MLC")&&t.jsxs("div",{className:"rounded-lg border border-primary/30 bg-primary/5 p-3",children:[t.jsx("p",{className:"text-sm font-medium text-primary mb-2",children:"Recommended Model"}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium",children:"Qwen2.5-Coder-1.5B"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"~756 MB â€¢ Best for diagrams"})]}),t.jsxs(I,{variant:"outline",size:"sm",onClick:()=>ve("Qwen2.5-Coder-1.5B-Instruct-q4f16_1-MLC"),disabled:N!==null,className:"gap-1",children:[t.jsx(Qe,{className:"h-3 w-3"}),"Download"]})]})]}),N&&t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[t.jsxs("span",{className:"flex items-center gap-2",children:[t.jsx(Qe,{className:"h-3 w-3 animate-pulse"}),"Downloading ",N,"..."]}),t.jsxs("span",{children:[Math.round(y*100),"%"]})]}),t.jsx("div",{className:"h-2 w-full overflow-hidden rounded-full bg-muted",children:t.jsx("div",{className:"h-full bg-primary transition-all duration-300",style:{width:`${y*100}%`}})})]}),t.jsxs("div",{className:"flex gap-2 border-b pb-2",children:[t.jsxs("button",{type:"button",onClick:()=>l("available"),className:`flex-1 pb-2 text-sm font-medium transition-colors ${i==="available"?"border-b-2 border-primary text-primary":"text-muted-foreground hover:text-foreground"}`,children:["Available (",yt.length,")"]}),t.jsxs("button",{type:"button",onClick:()=>l("downloaded"),className:`flex-1 pb-2 text-sm font-medium transition-colors ${i==="downloaded"?"border-b-2 border-primary text-primary":"text-muted-foreground hover:text-foreground"}`,children:["Downloaded (",Fe.length,")"]})]}),t.jsxs("div",{className:"relative",children:[t.jsx(On,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),t.jsx(Ee,{placeholder:"Search models...",value:q,onChange:c=>ce(c.target.value),className:"h-8 pl-8"})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto space-y-2 min-h-0",children:[i==="available"&&yt.map(c=>t.jsxs("div",{className:"flex items-center justify-between rounded-lg border p-3",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"text-sm font-medium truncate",children:c.name}),t.jsxs("p",{className:"text-xs text-muted-foreground",children:["~",c.vramMB," MB",c.lowResource&&" â€¢ Low resource"]})]}),t.jsxs(I,{variant:"outline",size:"sm",onClick:()=>ve(c.id),disabled:tn,className:"ml-2 shrink-0 gap-1",children:[t.jsx(Qe,{className:"h-3 w-3"}),"Download"]})]},c.id)),i==="downloaded"&&(Fe.length===0?t.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:q?"No models match your search":"No downloaded models yet"}):Fe.map(c=>{const x=o.type==="webllm"&&o.modelId===c.id;return t.jsxs("div",{className:`flex items-center justify-between rounded-lg border p-3 ${x?"border-primary bg-primary/5":""}`,children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("p",{className:"text-sm font-medium truncate",children:c.name}),x&&t.jsx(Ae,{className:"h-3 w-3 text-primary"})]}),t.jsxs("p",{className:"text-xs text-muted-foreground",children:["~",c.vramMB," MB"]})]}),t.jsxs("div",{className:"flex gap-1 ml-2 shrink-0",children:[!x&&t.jsx(I,{variant:"outline",size:"sm",onClick:()=>m({type:"webllm",modelId:c.id}),className:"gap-1",children:"Select"}),t.jsxs(I,{variant:"outline",size:"sm",onClick:()=>fe(c.id),disabled:d==="testing",className:"gap-1",children:[d==="testing"?t.jsx(Me,{className:"h-3 w-3 animate-spin"}):t.jsx(Ln,{className:"h-3 w-3"}),"Test"]}),t.jsx(I,{variant:"ghost",size:"sm",onClick:()=>h(c.id),className:"text-destructive hover:text-destructive",children:t.jsx(Bn,{className:"h-3 w-3"})})]})]},c.id)}))]})]}),s==="local"&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-sm font-medium",children:"Provider"}),t.jsx("select",{value:o.serverType||"opencode",onChange:c=>{const x=c.target.value,O=ne.find(te=>te.type===x),P=O?.defaultUrl||"http://127.0.0.1:4096";m({...o,serverType:x,url:P,model:""}),_([]),z("idle"),O?.defaultUrl&&D(O.defaultUrl,o.apiKey,O.type)},className:"w-full h-9 rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus:outline-none focus:ring-1 focus:ring-ring disabled:opacity-50",children:ne.map(c=>t.jsxs("option",{value:c.type,disabled:c.comingSoon,children:[c.name,c.comingSoon?" (Coming Soon)":"",!c.comingSoon&&c.type==="opencode"?" (Recommended)":""]},c.type))}),t.jsx("p",{className:"text-xs text-muted-foreground",children:ne.find(c=>c.type===o.serverType)?.description})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{className:"text-sm font-medium",children:"Server URL"}),t.jsxs("div",{className:"group relative",children:[t.jsx(xt,{className:"h-4 w-4 text-muted-foreground cursor-help"}),t.jsx("div",{className:"pointer-events-none absolute left-full top-0 z-10 ml-2 w-72 rounded-md border bg-background p-2 text-xs text-muted-foreground shadow-lg opacity-0 group-hover:opacity-100 transition-opacity",children:V(o.serverType)})]})]}),t.jsx(Ee,{placeholder:"http://127.0.0.1:4096",value:o.url||"",onChange:c=>{const x=c.target.value;m({...o,url:x}),_([])},disabled:Ke}),Ke&&t.jsx("p",{className:"text-xs text-amber-500 font-medium",children:"Coming soon! Only OpenCode Serve is available now."}),t.jsxs("p",{className:"text-xs text-muted-foreground",children:["Default:"," ",ne.find(c=>c.type===o.serverType)?.defaultUrl||"Not set"]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("button",{type:"button",onClick:()=>Be(!re),className:"flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground transition-colors",children:[t.jsx(Rt,{className:`h-4 w-4 transition-transform ${re?"rotate-180":""}`}),"Advanced Settings"]}),re&&t.jsxs("div",{className:"space-y-2 pt-2",children:[t.jsx("label",{className:"text-sm font-medium",children:"API Key (optional)"}),t.jsx(Ee,{type:"password",placeholder:"sk-...",value:o.apiKey||"",onChange:c=>m({...o,apiKey:c.target.value})}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Most local servers don't require an API key"})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{className:"text-sm font-medium",children:"Model"}),t.jsxs("div",{className:"group relative",children:[t.jsx(xt,{className:"h-4 w-4 text-muted-foreground cursor-help"}),t.jsxs("div",{className:"pointer-events-none absolute left-full top-0 z-10 ml-2 w-72 rounded-md border bg-background p-2 text-xs text-muted-foreground shadow-lg opacity-0 group-hover:opacity-100 transition-opacity",children:["For best results, use fast models with good instruction following:",t.jsxs("ul",{className:"mt-1 list-disc pl-4 space-y-0.5",children:[t.jsxs("li",{children:[t.jsx("strong",{children:"GPT-4o"}),","," ",t.jsx("strong",{children:"GPT-4o-mini"})," - Fast & capable"]}),t.jsxs("li",{children:[t.jsx("strong",{children:"Haiku"}),", ",t.jsx("strong",{children:"Flash"})," - Very fast"]}),t.jsxs("li",{children:[t.jsx("strong",{children:"Instruct models"})," (e.g., Qwen2.5-Coder-Instruct) - Great for diagrams"]}),t.jsx("li",{children:"Avoid: reasoning-heavy models (o1, o3-mini)"})]})]})]})]}),F.length>0?t.jsxs(Tt,{value:o.model||"",onValueChange:c=>{o.serverType==="opencode"&&we(o.url),m({...o,model:c})},children:[t.jsx(It,{children:t.jsx(At,{placeholder:"Select a model..."})}),t.jsx(Lt,{className:"max-h-[240px]",children:F.map(c=>t.jsx(rt,{value:c.id,children:c.name},c.id))})]}):t.jsx(Ee,{placeholder:"Enter model name (e.g., qwen2.5-coder-1.5b)",value:o.model||"",onChange:c=>{const x=c.target.value;o.serverType==="opencode"&&we(o.url),m({...o,model:x})}}),t.jsx("p",{className:"text-xs text-muted-foreground",children:F.length>0?"Select from available models or type a custom name":"Type the exact model name as shown in your server"})]})]}),s==="byok"&&t.jsxs("div",{className:"rounded-lg border border-amber-500/30 bg-amber-500/10 p-4 text-sm text-amber-700 dark:text-amber-400",children:[t.jsx("p",{className:"font-medium",children:"Coming Soon"}),t.jsx("p",{className:"mt-1",children:"Cloud AI providers (OpenAI, Anthropic, Google) will be available in a future update. These require a backend proxy for secure API key handling."})]}),b&&t.jsxs("div",{className:"flex items-center gap-2 rounded-lg border border-destructive/30 bg-destructive/10 p-3 text-sm text-destructive",children:[t.jsx(ln,{className:"h-4 w-4 shrink-0"}),t.jsx("span",{children:b})]}),s==="local"&&$e==="connected"&&o.model&&t.jsxs("div",{className:"rounded-lg border border-green-500/30 bg-green-500/10 p-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-600 dark:text-green-400 mb-2",children:[t.jsx(Ae,{className:"h-4 w-4 shrink-0"}),t.jsxs("span",{children:["Connected â€” ",o.model]})]}),d==="success"&&E&&t.jsx("p",{className:"text-sm text-foreground",children:E})]})]}),t.jsxs(Je,{className:"gap-2 sm:gap-0 px-6 py-4 border-t",children:[t.jsxs(I,{variant:"outline",size:"sm",onClick:We,className:"gap-2",children:[t.jsx(_n,{className:"h-4 w-4"}),"Reset"]}),t.jsxs("div",{className:"flex gap-2",children:[s==="local"&&t.jsx(I,{variant:"outline",size:"sm",onClick:K,disabled:d==="testing",className:"gap-2",children:d==="testing"?t.jsxs(t.Fragment,{children:[t.jsx(Me,{className:"h-4 w-4 animate-spin"}),"Testing..."]}):"Test"}),t.jsx(I,{size:"sm",onClick:ze,disabled:p||s==="byok",className:"gap-2",children:p?t.jsxs(t.Fragment,{children:[t.jsx(Me,{className:"h-4 w-4 animate-spin"}),"Saving..."]}):"Save"})]})]})]},e?"open":"closed")}),t.jsx(qe,{open:!!M,onOpenChange:c=>!c&&Se(),children:t.jsxs(He,{className:"sm:max-w-[400px]",children:[t.jsxs(Ye,{children:[t.jsx(Ve,{children:"Download Model?"}),t.jsxs(Xe,{children:["Download ",M,"? This may take some time depending on your internet connection."]})]}),t.jsxs(Je,{className:"gap-2",children:[t.jsx(I,{variant:"outline",size:"sm",onClick:Se,children:"Cancel"}),t.jsx(I,{size:"sm",onClick:()=>M&&Ue(M),children:"Download"})]})]})}),t.jsx(qe,{open:!!L,onOpenChange:c=>!c&&R(),children:t.jsxs(He,{className:"sm:max-w-[400px]",children:[t.jsxs(Ye,{children:[t.jsx(Ve,{children:"Delete Model?"}),t.jsxs(Xe,{children:["Are you sure you want to delete ",L,"? You can download it again later."]})]}),t.jsxs(Je,{className:"gap-2",children:[t.jsx(I,{variant:"outline",size:"sm",onClick:R,children:"Cancel"}),t.jsx(I,{variant:"destructive",size:"sm",onClick:()=>L&&Z(L),children:"Delete"})]})]})})]})}const _r={intervalBaselineMs:1e3,intervalScaleMs:2500,maxIntervalMs:8e3,maxConcurrentGenerations:2,minTranscriptLength:3,maxStackSize:50},pt="drawmaid-auto-mode";function Dr(){if(typeof window>"u")return!0;try{const e=localStorage.getItem(pt);return e===null?(localStorage.setItem(pt,"true"),!0):e==="true"}catch{return!0}}function Or(e){if(!(typeof window>"u"))try{localStorage.setItem(pt,String(e))}catch{}}class Pr{state;config;checkTimeoutId=null;currentIntervalMs;onGenerate;onResult;lastTriggeredText="";transcriptGetter=()=>"";_activeGenerations=new Map;_oldestGenerationId=null;constructor(n={},r,s){this.config={..._r,...n},this.currentIntervalMs=this.config.intervalBaselineMs,this.onGenerate=r,this.onResult=s,this.state={isAutoMode:!0,lastProcessedTranscript:"",mermaidStack:[],mermaidStackHead:0,generationCounter:0,lastSuccessfulGenId:-1}}getIntervalForGeneration(n){const r=Math.log2(n+1),s=this.config.intervalBaselineMs+r*this.config.intervalScaleMs;return Math.min(s,this.config.maxIntervalMs)}start(n){this.transcriptGetter=n,this.scheduleNextTick()}stop(){this.checkTimeoutId!==null&&(clearTimeout(this.checkTimeoutId),this.checkTimeoutId=null),this._activeGenerations.clear(),this._oldestGenerationId=null,this.lastTriggeredText="",this.currentIntervalMs=this.config.intervalBaselineMs,this.state.generationCounter=0,this.state.lastSuccessfulGenId=-1,this.state.lastProcessedTranscript="",this.state.mermaidStack=[],this.state.mermaidStackHead=0}scheduleNextTick(){this.checkTimeoutId!==null&&clearTimeout(this.checkTimeoutId),this.checkTimeoutId=setTimeout(()=>{this.onIntervalTick()},this.currentIntervalMs)}onIntervalTick(){const n=this.transcriptGetter();if(n.trim().length<this.config.minTranscriptLength){this.scheduleNextTick();return}n!==this.lastTriggeredText&&this.triggerGeneration(n),this.scheduleNextTick()}triggerGeneration(n){this._activeGenerations.size>=this.config.maxConcurrentGenerations&&this._oldestGenerationId!==null&&(this._activeGenerations.delete(this._oldestGenerationId),this._oldestGenerationId=null);const r=++this.state.generationCounter,s={id:r,transcript:n,timestamp:Date.now(),modelId:"",useLocalServer:!1};this._activeGenerations.set(s.id,Date.now()),this._oldestGenerationId===null&&(this._oldestGenerationId=r),this.currentIntervalMs=this.getIntervalForGeneration(this.state.generationCounter),this.executeGeneration(s)}async executeGeneration(n){try{const r=await this.onGenerate(n);if(n.id<this.state.lastSuccessfulGenId){this._activeGenerations.delete(n.id),this._oldestGenerationId===n.id&&(this._oldestGenerationId=this.findNewOldest());return}r&&(this.state.lastSuccessfulGenId=n.id,this.state.lastProcessedTranscript=n.transcript,this.lastTriggeredText=n.transcript,this.pushToStack(r)),this._activeGenerations.delete(n.id),this._oldestGenerationId===n.id&&(this._oldestGenerationId=this.findNewOldest()),this.onResult(r,n)}catch{this._activeGenerations.delete(n.id),this._oldestGenerationId===n.id&&(this._oldestGenerationId=this.findNewOldest())}}findNewOldest(){let n=null,r=1/0;for(const[s,a]of this._activeGenerations.entries())a<r&&(r=a,n=s);return n}pushToStack(n){const{mermaidStack:r,mermaidStackHead:s}=this.state,a=this.config.maxStackSize;r.length<a?r.push(n):(r[s]=n,this.state.mermaidStackHead=(s+1)%a)}getState(){return{...this.state}}isRunning(){return this.checkTimeoutId!==null}getActiveCount(){return this._activeGenerations.size}retryWithCurrentTranscript(){const n=this.transcriptGetter();n.trim().length>=this.config.minTranscriptLength&&this.triggerGeneration(n)}}const Gr=300;let tt=[];function $r(e,n,r){const s=e.scrollX??0,a=e.scrollY??0,i=typeof e.zoom=="object"&&e.zoom!==null?e.zoom.value:e.zoom??1,l=-s+n/2/i,o=-a+r/2/i;return{x:l,y:o}}function Br(){const e=document.querySelector(".excalidraw-container");return e?{width:e.clientWidth,height:e.clientHeight}:{width:800,height:600}}function Ur(e){if(e.length===0)return[0,0,0,0];const n=Math.min(...e.map(i=>i.x)),r=Math.min(...e.map(i=>i.y)),s=Math.max(...e.map(i=>i.x+(i.width||0))),a=Math.max(...e.map(i=>i.y+(i.height||0)));return[n,r,s,a]}function zr(e,n){if(e.length===0)return e;const r=Ur(e),s=r[2]-r[0],a=r[3]-r[1],i=n.x-s/2-r[0],l=n.y-a/2-r[1];return e.map(o=>({...o,x:o.x+i,y:o.y+l}))}async function ft(e,n,r){const{elements:s,files:a}=await dn(n),i=un(s,{regenerateIds:!0}),l=e.getAppState(),o=Br(),m=$r(l,o.width,o.height),d=zr(i,m),f=e.getSceneElements();let b;r?.replace&&tt.length>0?b=[...f.filter(p=>!tt.includes(p.id)),...d]:b=[...f,...d],tt=d.map(g=>g.id),e.updateScene({elements:b,captureUpdate:mn.IMMEDIATELY}),a&&Object.keys(a).length>0&&e.addFiles?.(Object.values(a)),e.refresh(),e.scrollToContent(d,{fitToContent:!0,animate:!0,duration:Gr})}const Wr={id:"flowchart",name:"Flowchart",nodeSyntax:"A[Label] or B(Label) or C{Decision}",edgeSyntax:"A --> B or A -->|label| B",reservedWords:["end","graph","class","click","default","state","subgraph","link","style","direction","flowchart"],examples:[`flowchart TD
Node1[Label Text] --> Node2{Decision}
Node2 -->|Option A| Node3[Result A]
Node2 -->|Option B| Node4[Result B]`],tips:["Node IDs must be single words without spaces","Labels go INSIDE brackets: A[My Label]","Use --> for arrows, -->|text| for labeled arrows","Shapes: [rectangle], (rounded), {decision}, [/parallelogram/]"]},Fr={id:"sequenceDiagram",name:"Sequence Diagram",nodeSyntax:"participant Name as 'Label'",edgeSyntax:"A ->> B: message or A -->> B: dotted message",reservedWords:["end","loop","alt","else","par","break","critical","section","note","activate","deactivate","create","destroy"],examples:[`sequenceDiagram
participant Entity1
participant Entity2
Entity1 ->> Entity2: Message description
Entity2 -->> Entity1: Response description`],tips:["Define participants first: participant User","Arrows: ->> (solid), -->> (dotted), ->>+ (activate), ->>- (deactivate)","Use 'as' for display names: participant U as User","Can use actor instead of participant"]},Kr={id:"classDiagram",name:"Class Diagram",nodeSyntax:"class Name { +attribute -method() }",edgeSyntax:"ClassA <|-- ClassB (inheritance) or ClassA --> ClassB (association)",reservedWords:["class","interface","enum","abstract","static","extends","implements"],examples:[`classDiagram
class ClassName {
+String attribute
+method()
}
class AnotherClass
ClassName <|-- AnotherClass`],tips:["Define classes with attributes and methods","Visibility: + (public), - (private), # (protected)","Relationships: <|-- (inheritance), --> (association), ..> (dependency)","Use <<interface>> for interfaces"]},qr={flowchart:Wr,sequenceDiagram:Fr,classDiagram:Kr},nt=qr;function Vt(e){return e&&nt[e]?nt[e]:nt.flowchart}const Hr={flowchart:["flowchart","flow chart","flow","process","decision tree"],sequenceDiagram:["sequence diagram","sequencing","sequence","interactions","message flow","process order","timeline","call flow","request response"],classDiagram:["class diagram","class","classes","oop","object oriented","uml class","inheritance"]},Yr={LR:["left to right","left-to-right","horizontal","lr","left right","l to r"],RL:["right to left","right-to-left","rtl","right left","r to l"],TD:["top down","top-down","vertical","td","top bottom","t to d"],BT:["bottom to top","bottom-to-top","bt","bottom top","b to t"]},Vr=new Set(["a","an","the","and","or","but","because","so","in","on","at","to","for","of","with","by","from","as","into","through","i","me","my","you","your","he","him","his","she","her","it","its","we","us","our","they","them","their","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","can","could","should","may","might","diagram","flowchart","graph","sequence","class","node","edge","vertex","link","style","flow","chart","left","right","up","down","top","bottom","horizontal","vertical","td","lr","rl","bt","up","down","create","draw","show","make","generate","display","get","use","go","see","wait"]),Xr=`Output ONLY valid mermaid code. No explanations. No markdown fences.

USER REQUEST: "{{transcript}}"

CRITICAL FORMATTING RULES:

1. NO indentation - every line starts at column 0
2. If using |label| on arrow, target MUST be on SAME line
3. Every --> arrow must have a target node on the same line
4. Each statement is exactly ONE line

SYNTAX RULES FOR {{diagramType}}:

- Node syntax: {{nodeSyntax}}
- Edge syntax: {{edgeSyntax}}
- Reserved keywords to AVOID: {{reservedWords}}

{{tips}}

ENTITIES TO CONSIDER (use only if aligned with request): {{entities}}

Complete the mermaid code:
{{firstLine}}

SYNTAX REFERENCE (shows valid patterns - do not copy content):
{{example}}
`,Jr=`CRITICAL: Fix the mermaid syntax error below.

ORIGINAL REQUEST: "{{originalInput}}"

FAILED CODE:

\`\`\`
{{failedCode}}
\`\`\`

PARSE ERROR: {{errorMessage}}

{{specificFix}}

STRICT RULES - MUST FOLLOW:

1. NO indentation - every line starts at column 0 (no spaces/tabs at start)
2. If using |label| on arrow, target MUST be on SAME line
3. Every --> arrow must point to something on the same line
4. Each statement is ONE line only

CORRECT EXAMPLE:
flowchart TD
A[Start] --> B{Decision}
B -->|Yes| C[Process]
B -->|No| D[End]

INCORRECT (will fail):
flowchart TD
A[Start] <-- has spaces
B -->|Label| <-- missing target
C[End] <-- indented

SYNTAX: {{nodeSyntax}} | {{edgeSyntax}}

Rewrite the FAILED CODE above with NO indentation and complete all arrows:
{{firstLine}}
`;function Xt(e){const n=new Map,r=[];for(const[i,l]of Object.entries(e))for(const o of l)r.push(o),n.set(o.toLowerCase(),i);r.sort((i,l)=>l.length-i.length);const s=r.map(i=>i.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&"));return{regex:new RegExp(`\\b(${s.join("|")})\\b`,"gi"),keyMap:n}}const Qr=Xt(Hr),Zr=Xt(Yr);function Jt(e,n){const r=e.toLowerCase(),s=[];let a;for(n.regex.lastIndex=0;(a=n.regex.exec(r))!==null;){const i=a[1],l=n.keyMap.get(i);l&&s.push({key:l,match:i,position:a.index})}return s.length===0?null:(s.sort((i,l)=>l.position-i.position),s[0])}function es(e){return Jt(e,Qr)?.key??null}function ts(e){return Jt(e,Zr)?.key??null}function ns(e){if(typeof Intl>"u"||!Intl.Segmenter)return[];const r=[...new Intl.Segmenter("en",{granularity:"word"}).segment(e)],s=[];for(const l of r){const o=l.segment.toLowerCase().trim();o.length>2&&o.length<=30&&/^[a-z0-9]+$/.test(o)&&!Vr.has(o)&&s.push(o)}const a=new Set,i=[];for(const l of s)a.has(l)||(a.add(l),i.push(l));return i.slice(0,8)}const de=new Map,rs=50,ss=50;function Qt(e){if(de.has(e))return de.get(e);const n=es(e),r=ts(e);let s=[];e.length<ss&&(s=ns(e));const a={diagramType:n,direction:r,entities:s};if(de.size>=rs){const i=de.keys().next().value;i&&de.delete(i)}return de.set(e,a),a}function Zt(e,n){const r=Vt(n.diagramType),s=n.diagramType||"flowchart",a=n.direction||"TD",i=s==="flowchart"?`${s} ${a}`:s;let l="";r.tips.length>0&&(l=`
- Tips:`+r.tips.map(d=>`
  * `+d).join(""));let o="";n.entities.length>0&&(o=n.entities.map(d=>d.charAt(0).toUpperCase()+d.slice(1)).join(", "));let m="";return r.examples.length>0&&(m=r.examples[0]),Xr.replace("{{transcript}}",e).replace("{{diagramType}}",r.name.toUpperCase()).replace("{{nodeSyntax}}",r.nodeSyntax).replace("{{edgeSyntax}}",r.edgeSyntax).replace("{{reservedWords}}",r.reservedWords.join(", ")).replace("{{tips}}",l).replace("{{entities}}",o).replace("{{firstLine}}",i).replace("{{example}}",m)}const os=[{pattern:/got 'NEWLINE'/i,title:"INCOMPLETE EDGE OR INDENTATION",cause:"Edge has label but no target node, OR line has leading spaces",fix:"If edge has |label|, the target must be on SAME line: A -->|label| B. Remove ALL indentation from every line.",badExample:"D -->|Invalid|\\n  F[Error]",goodExample:"D -->|Invalid| F[Error]"},{pattern:/Expecting.*SPACE.*AMP.*COLON.*DOWN/i,title:"MISSING ARROW CONNECTIONS",cause:"Nodes listed without arrow connections (-->) on same line",fix:"Every node must connect to next with --> on SAME line",badExample:"A[Start]\\nB[Process]",goodExample:"A[Start] --> B[Process]"},{pattern:/redefinition of node|duplicate/i,title:"DUPLICATE NODE IDS",cause:"Same ID (A, B, C) used for multiple different nodes",fix:"Use unique IDs for each node",badExample:"A[Login] and later A[Logout]",goodExample:"A[Login] and B[Logout]"},{pattern:/unclosed|bracket|parenthesis|expecting.*BRKT/i,title:"MISMATCHED BRACKETS",cause:"Missing closing bracket ] or parenthesis )",fix:"Ensure every [ has a ] and every ( has a )",badExample:"A[Start --> B[End]",goodExample:"A[Start] --> B[End]"},{pattern:/reserved|keyword|end|class|graph/i,title:"RESERVED KEYWORD AS NODE ID",cause:"Using reserved words like 'end', 'class', 'graph' as node names",fix:"Add underscore suffix: end_, class_, graph_",badExample:"end[Finish]",goodExample:"end_[Finish]"}];function as(e){for(const n of os)if(n.pattern.test(e))return`SPECIFIC ERROR DETECTED: ${n.title}

Cause: ${n.cause}
Fix: ${n.fix}
Example:
  Wrong: ${n.badExample}
  Right: ${n.goodExample}`;return`GENERAL SYNTAX ERROR

The mermaid code has a syntax error. Common issues:
- Missing arrow connections between nodes (use --> )
- Extra spaces at start of lines (remove all indentation)
- Unclosed brackets [ ] or parentheses ( )
- Reserved words used as node names (add _ suffix)

Check the failed code above and fix these issues.`}function is(e){const n=e.diagramType||"flowchart",r=Vt(e.diagramType),s=n==="flowchart"?`${n} TD`:n,a=as(e.errorMessage);return Jr.replace("{{originalInput}}",e.originalInput).replace("{{failedCode}}",e.failedMermaidCode).replace("{{errorMessage}}",e.errorMessage).replace("{{specificFix}}",a).replace("{{nodeSyntax}}",r.nodeSyntax).replace("{{edgeSyntax}}",r.edgeSyntax).replace("{{firstLine}}",s)}const jt="```mermaid",Et=/^```[\w]*\n?/,Nt="```";function ls(e){let n=e.trim();return n.startsWith(jt)?(n=n.slice(jt.length),n.startsWith(`
`)&&(n=n.slice(1)),n=n.trim()):Et.test(n)&&(n=n.replace(Et,"").trim()),n.endsWith(Nt)&&(n=n.slice(0,-Nt.length).trim()),n}function ht(e){const r=ls(e).trim();return!r||!/[a-zA-Z]/.test(r)||r.length<10?null:r}function cs(e){const{excalidrawApiRef:n,isAutoMode:r,transcript:s}=e,[a,i]=u.useState(!1),l=u.useRef(null),o=u.useRef(""),m=u.useRef(e),d=u.useRef(s);m.current=e,d.current=s;const f=u.useCallback(async g=>{const{onError:p,onGeneratingChange:v}=m.current;i(!0),v?.(!0);const{currentModel:y,localModels:j,generate:T}=m.current,N=j.some(k=>k.id===y)&&j.length>0;try{const k=Qt(g.transcript),E=Zt(g.transcript,k);return await T(E,{systemPrompt:J,modelId:y,useLocalServer:N,disableAbort:!0,timeoutMs:N?void 0:15e3})}catch(k){const E=k instanceof Error?k.message:"Generation failed";return p?.(E),null}finally{i(!1),v?.(!1)}},[]),b=u.useCallback(async(g,p)=>{const{onError:v}=m.current,y=n.current;if(!g||!y)return;const j=ht(g);if(!j){l.current?.retryWithCurrentTranscript();return}try{await ft(y,j,{replace:!0}),o.current=p.transcript}catch(T){const C=T instanceof Error?T.message:"Failed to insert diagram";v?.(C),l.current?.retryWithCurrentTranscript()}},[n]);return u.useEffect(()=>{if(!r){l.current?.stop(),l.current=null;return}return l.current=new Pr({},f,b),l.current.start(()=>d.current),()=>{l.current?.stop(),l.current=null}},[r,f,b]),{isGenerating:a}}function ds(){u.useEffect(()=>{if(typeof document>"u")return;const e=document.documentElement,n=()=>{const d=document.querySelector(".excalidraw");if(!d)return;const f=getComputedStyle(d);d.classList.contains("theme--dark")?e.classList.add("dark"):e.classList.remove("dark");const g=d.querySelector(".App-toolbar"),p=d.querySelector(".Island"),v=d.querySelector(".ToolIcon--selected");let y;if(g||p){const w=getComputedStyle(g||p);y=w.backgroundColor;const M=w.color,S=w.borderColor;y&&y!=="rgba(0, 0, 0, 0)"&&y!=="transparent"&&(e.style.setProperty("--card",y),e.style.setProperty("--popover",y),e.style.setProperty("--secondary",y),e.style.setProperty("--muted",y),e.style.setProperty("--toolbar-bg",y)),M&&M!=="rgba(0, 0, 0, 0)"&&e.style.setProperty("--foreground",M),S&&S!=="rgba(0, 0, 0, 0)"&&S!=="transparent"&&(e.style.setProperty("--border",S),e.style.setProperty("--input",S))}if(v){const w=getComputedStyle(v).backgroundColor;w&&w!=="rgba(0, 0, 0, 0)"&&w!=="transparent"&&e.style.setProperty("--primary",w)}const j=d.querySelector(".ToolIcon:not(.ToolIcon--selected)");if(j){const E=getComputedStyle(j),w=E.backgroundColor,M=E.color,S=w&&w!=="rgba(0, 0, 0, 0)"&&w!=="transparent"?w:y;S&&e.style.setProperty("--toolbar-button-bg",S),M&&M!=="rgba(0, 0, 0, 0)"&&e.style.setProperty("--toolbar-button-color",M)}else y&&e.style.setProperty("--toolbar-button-bg",y);const T=d.querySelector(".sidebar-trigger");if(T){const E=getComputedStyle(T),w=E.backgroundColor,M=E.color;w&&w!=="rgba(0, 0, 0, 0)"&&w!=="transparent"&&e.style.setProperty("--sidebar-trigger-bg",w),M&&M!=="rgba(0, 0, 0, 0)"&&e.style.setProperty("--sidebar-trigger-color",M),e.style.setProperty("--sidebar-trigger-hover-bg",w||y||"")}const C=E=>{const w=f.getPropertyValue(E)?.trim();return w&&w!=="initial"&&w!=="inherit"&&w!==""?w:null},N=C("--color-primary"),k=C("--color-surface-lowest");N&&e.style.setProperty("--primary",N),k&&e.style.setProperty("--background",k)};let r=0;const s=50;let a=null;const i=()=>{n(),!document.querySelector(".excalidraw")&&r<s&&(r++,a=setTimeout(i,100))};i();const l=new MutationObserver(()=>{n()});let o=0;const m=setInterval(()=>{const d=document.querySelector(".excalidraw");d?(l.observe(d,{attributes:!0,attributeFilter:["class"]}),clearInterval(m)):o++>50&&clearInterval(m)},100);return()=>{l.disconnect(),clearInterval(m),a&&clearTimeout(a)}},[])}const us="WebGPU is not supported in this browser";function en(){return Promise.reject(new Error(us))}const ms=en,ps=()=>en();function fs(){const e=u.useSyncExternalStore(lt,Ie),n=Nr();return{isSupported:n,...e,load:n?De:ms,generate:async(s,a)=>{const i=await dr();if(a?.useLocalServer&&i.type==="local"){const l=i,o=a?.modelId||l.model;return l.serverType==="opencode"?Yt({...i,model:o},a?.systemPrompt??J,s):Tr({...i,model:o},a?.systemPrompt??J,s,{maxTokens:a?.maxTokens,temperature:a?.temperature,timeoutMs:a?.timeoutMs})}return n?Ft(s,a):ps()},abort:kr,unload:Kt}}const kt="Qwen2.5-Coder-1.5B-Instruct-q4f16_1-MLC";function js(){const[e,n]=u.useState(""),[r,s]=u.useState(()=>Dr()?"auto":"normal"),[a,i]=u.useState("dark"),[l,o]=u.useState(!1),[m,d]=u.useState(null),[f,b]=u.useState(null);u.useEffect(()=>{if(!m)return;const h=setTimeout(()=>{d(null),b(null)},8e3);return()=>clearTimeout(h)},[m]);const[g,p]=u.useState(!1),[v,y]=u.useState(!1),[j,T]=u.useState([]),[C,N]=u.useState(kt),[k,E]=u.useState(!1),[w,M]=u.useState(()=>X()),[S,L]=u.useState([]),U=u.useMemo(()=>new Set(j.map(h=>h.id)),[j]);u.useEffect(()=>{Ot().then(L).catch(h=>console.error("Failed to load WebLLM models:",h))},[]);const q=S.filter(h=>w.includes(h.id)),{isSupported:ce,status:H,loadProgress:Y,generate:F}=fs(),_=u.useRef(null),{isGenerating:$e}=cs({excalidrawApiRef:_,generate:F,currentModel:C,localModels:j,isAutoMode:r==="auto",transcript:e,onError:h=>{const Z=U.has(C)&&j.length>0?"local":"webllm";d(h),b({message:h,timestamp:new Date().toISOString(),mode:r,model:C,transcript:e,provider:Z})}}),z=h=>{const Z=U.has(C)&&j.length>0?"local":"webllm";d(h),b({message:h,timestamp:new Date().toISOString(),mode:r,model:C,transcript:e,provider:Z})},re=u.useCallback(h=>{h.type==="local"&&"url"in h&&h.url&&zt(h.url,h.apiKey,h.serverType).then(R=>{R.success&&R.models&&T(R.models)})},[]);u.useEffect(()=>{const h=Bt(),R=h.type==="local";if(E(R),R)h.model&&N(h.model),re(h);else{const V=X()[0]||kt;N(V)}return Gt(D=>{const V=D.type==="local";E(V),V?(D.model&&N(D.model),re(D)):D.type==="webllm"&&D.modelId&&N(D.modelId)})},[re]),u.useEffect(()=>(M(X()),pr(R=>{M(R)})),[]);const Be=h=>{N(h)},ve=()=>{i(h=>h==="dark"?"light":"dark")},Se=h=>{s(h),Or(h==="auto")};u.useEffect(()=>{if(typeof document>"u")return;const h=document.documentElement;a==="dark"?h.classList.add("dark"):h.classList.remove("dark")},[a]),ds();const Ue=async()=>{d(null),y(!0);let h=null;const R=Qt(e),Z=Zt(e,R),V=U.has(C)&&j.length>0;try{h=await F(Z,{systemPrompt:J,modelId:C,useLocalServer:V})}catch(K){if(y(!1),Oe(K))return;if(qt(K)){z("Generation timed out. Try a simpler request or check your connection.");return}z(K instanceof Error?K.message:"Generation failed. Please try again.");return}if(y(!1),!h?.trim())return;const fe=_.current;if(!fe)return;let se=null;try{if(se=ht(h),!se){y(!1);return}await ft(fe,se)}catch(K){y(!1);const ze=K instanceof Error?K.message:String(K),We=is({originalInput:e,failedMermaidCode:se||h,errorMessage:ze,diagramType:R.diagramType});try{const ee=await F(We,{systemPrompt:J,maxTokens:512,modelId:C,useLocalServer:V});if(!ee?.trim()){z("Could not fix diagram syntax. Please try a different description.");return}const Ce=ht(ee);if(!Ce){z("Could not fix diagram syntax. Please try a different description.");return}await ft(fe,Ce)}catch(ee){if(y(!1),Oe(ee))return;z(ee instanceof Error?ee.message:"Could not add diagram to canvas. Check the diagram syntax.")}}};return t.jsxs("div",{className:"relative h-dvh w-full",children:[t.jsxs(pn,{theme:a,excalidrawAPI:h=>{_.current=h,o(!0)},UIOptions:{canvasActions:{toggleTheme:!1}},initialData:void 0,children:[t.jsxs($,{children:[t.jsx($.DefaultItems.LoadScene,{}),t.jsx($.DefaultItems.SaveToActiveFile,{}),t.jsx($.DefaultItems.Export,{}),t.jsx($.DefaultItems.SaveAsImage,{}),t.jsx($.DefaultItems.SearchMenu,{}),t.jsx($.DefaultItems.Help,{}),t.jsx($.DefaultItems.ClearCanvas,{}),t.jsx($.Separator,{}),t.jsx($.Item,{onSelect:ve,children:t.jsxs("div",{className:"flex items-center gap-2",children:[a==="dark"?t.jsx(Gn,{className:"h-4 w-4"}):t.jsx(In,{className:"h-4 w-4"}),t.jsx("span",{children:a==="dark"?"Switch to light mode":"Switch to dark mode"})]})}),t.jsx($.Item,{onSelect:()=>p(!0),children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(st,{className:"h-4 w-4"}),t.jsx("span",{children:"AI Configuration"})]})}),t.jsx($.Separator,{}),t.jsx($.DefaultItems.ChangeCanvasBackground,{})]}),t.jsxs(W,{children:[t.jsxs(W.Center,{children:[t.jsx(W.Center.Logo,{children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(Hn,{className:"h-10 w-10 text-primary"}),t.jsx("span",{className:"text-3xl font-semibold",children:"Drawmaid"})]})}),t.jsx(W.Center.Heading,{children:"Create diagrams with AI"}),t.jsxs(W.Center.Menu,{children:[t.jsx(W.Center.MenuItemLoadScene,{}),t.jsx(W.Center.MenuItemLink,{href:"https://github.com/AchuAshwath/drawmaid",icon:t.jsx(Sn,{className:"h-4 w-4"}),children:"GitHub"}),t.jsx(W.Center.MenuItemHelp,{}),t.jsx(W.Center.MenuItemLink,{href:"#",icon:t.jsx(st,{className:"h-4 w-4"}),onClick:h=>{h.preventDefault(),p(!0)},children:"Configure AI"})]}),t.jsx("div",{className:"mt-4 w-full max-w-[550px]",children:t.jsx(Wt,{onConfigureClick:()=>p(!0)})})]}),t.jsx(W.Hints.ToolbarHint,{}),t.jsx(W.Hints.MenuHint,{}),t.jsx(W.Hints.HelpHint,{})]})]}),t.jsx("div",{className:"pointer-events-none absolute inset-x-0 top-4 flex justify-center z-50",children:t.jsx("div",{className:"pointer-events-auto w-full max-w-[550px] px-4"})}),t.jsx("div",{className:"pointer-events-none absolute inset-x-0 bottom-4 flex justify-center z-50",children:t.jsx("div",{className:"pointer-events-auto w-full max-w-[550px]",children:t.jsx(rr,{prompt:e,onPromptChange:h=>{n(h)},mode:r,onModeChange:Se,onGenerate:Ue,generateDisabled:r==="auto"||!e||H==="loading"||H==="generating"||!ce||!l,generating:H==="generating"||v||$e,onTranscript:h=>{n(h)},onRecognitionError:h=>z(h),loading:H==="loading"||v&&r==="normal",loadProgress:Y,webLLMModels:q,localModels:j,currentModel:C,onSelectModel:Be,localServerConfigured:k})})}),m&&t.jsx("div",{className:"pointer-events-none absolute top-4 right-4 z-50",children:t.jsxs("div",{className:"pointer-events-auto flex items-center gap-2 rounded-lg bg-destructive/90 px-4 py-2 text-destructive-foreground shadow-lg backdrop-blur-sm max-w-md",children:[t.jsx("span",{className:"text-sm break-words",children:m}),t.jsx(hs,{errorContext:f,onDismiss:()=>{d(null),b(null)}})]})}),t.jsx(Rr,{open:g,onOpenChange:p,onModelDownloaded:()=>{const h=X();M(h),h.length>0&&!C&&N(h[h.length-1])}})]})}function hs({errorContext:e,onDismiss:n}){const[r,s]=u.useState("copy"),a=async()=>{if(!e){await navigator.clipboard.writeText("No error details available"),s("copied"),setTimeout(()=>s("copy"),2e3);return}const i=`[Drawmaid Error Report]
Time: ${e.timestamp}
Mode: ${e.mode}
Provider: ${e.provider}
Model: ${e.model}

Transcript:
${e.transcript||"(empty)"}

Error Message:
${e.message}

---
Generated by Drawmaid`;await navigator.clipboard.writeText(i),s("copied"),setTimeout(()=>s("copy"),2e3)};return t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{type:"button",onClick:a,className:"rounded p-1 hover:bg-white/20 transition-colors","aria-label":"Copy error",title:"Copy error",children:r==="copy"?t.jsx(wn,{className:"h-3.5 w-3.5"}):t.jsx(Ae,{className:"h-3.5 w-3.5 text-green-400"})}),t.jsx("button",{type:"button",onClick:n,className:"rounded p-1 hover:bg-white/20 transition-colors","aria-label":"Dismiss error",title:"Dismiss",children:t.jsx(cn,{className:"h-3.5 w-3.5"})})]})}export{js as component};
